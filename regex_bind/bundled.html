<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PromptFlow - Advanced Prompt Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
body {
  font-family: 'Roboto', sans-serif;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Compact cards - FIXED HEIGHT, never changes */
.compact-card {
  position: relative;
  height: 50px; /* Fixed height - never changes */
  overflow: visible; /* Allow expanded panel to overflow */
  margin-bottom: 8px; /* Consistent spacing between cards */
}

/* Disabled item style */
.compact-card.item-disabled .show-when-compact {
  background: #f8fafc !important;
}

.compact-card.item-disabled .show-when-compact * {
  color: #94a3b8 !important;
}

/* The compact preview row */
.compact-card .show-when-compact {
  display: flex;
  height: 50px;
  background: white;
  border-radius: 6px;
  position: relative;
  z-index: 1;
}

/* Drag handle area */
.compact-card .drag-handle {
  border-right: 1px solid #f1f5f9;
  transition: background-color 0.15s;
}

.compact-card .drag-handle:hover {
  background-color: #f8fafc;
}

/* Content area - clickable */
.compact-card .content-area {
  transition: background-color 0.15s;
}

.compact-card .content-area:hover {
  background-color: #fafafa;
}

/* The expanded panel - ABSOLUTE positioned, floats below */
.compact-card .hide-when-compact {
  position: absolute;
  top: 50px; /* Start right below the compact row */
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e2e8f0;
  border-top: none;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
  pointer-events: none;
}

/* Expand panel when click-expanded (主面板点击展开) */
.compact-card.click-expanded .hide-when-compact {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

/* Elevated z-index for the expanded card container */
.compact-card.click-expanded {
  z-index: 50;
}

/* Visual enhancement for expanded state */
.compact-card.click-expanded .show-when-compact {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  border-radius: 6px 6px 0 0;
}

/* Disable during drag */
body.is-dragging .compact-card.click-expanded .hide-when-compact {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* Dragging styles */
.dragging {
  opacity: 0.5;
  border: 2px dashed #3b82f6;
}

.drop-zone-active {
  background-color: #eff6ff; /* blue-50 */
  outline: 2px dashed #6366f1;
  outline-offset: -2px;
  transition: background-color 0.2s ease, outline 0.2s ease;
}

/* Ghost element (follows cursor) */
.drag-ghost {
  animation: ghostAppear 0.15s ease-out;
  background: white;
}

@keyframes ghostAppear {
  from {
    opacity: 0;
    transform: rotate(0deg) scale(0.95);
  }
  to {
    opacity: 0.9;
    transform: rotate(2deg) scale(1.02);
  }
}

/* Drop preview element animation */
@keyframes previewPulse {
  0%,
  100% {
    opacity: 0.6;
    transform: scale(1);
  }
  50% {
    opacity: 0.9;
    transform: scale(1.01);
  }
}

.drop-preview {
  animation: previewPulse 1.2s ease-in-out infinite;
  transition: all 0.15s ease;
}

/* Smooth transition for items when dragging */
[draggable='true'] {
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

[draggable='true']:active {
  cursor: grabbing;
}

/* Hide browser default drag image */
[draggable='true'] {
  -webkit-user-drag: element;
}

/* Items animate when reordering */
.item-enter {
  animation: itemEnter 0.25s ease-out;
}

@keyframes itemEnter {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.98);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

</style>
  </head>
  <body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header
      class="bg-white border-b border-slate-200 h-14 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm"
    >
      <div class="flex items-center gap-2">
        <img src="data:image/png;base64,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" alt="Singularity" class="h-6 w-6" />
        <h1 class="font-bold text-lg text-slate-700">SPreset Editor</h1>
      </div>
      <div class="flex gap-3">
        <button
          id="btn-save-preset"
          class="flex items-center gap-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors"
        >
          <span class="material-symbols-outlined text-[18px]">save</span>
          保存
        </button>
        <button
          id="btn-exit-iframe"
          onclick="exitIframe()"
          class="hidden items-center gap-1 text-slate-500 hover:text-red-600 px-3 py-1.5 rounded text-sm transition-colors"
          title="退出编辑器"
        >
          <span class="material-symbols-outlined text-[18px]">close</span>
          退出
        </button>
      </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
      <!-- Zone 1: Unused Items (Left) -->
      <section class="flex-1 min-w-[300px] flex flex-col border-r border-slate-200 bg-slate-50">
        <div class="p-3 border-b border-slate-200 bg-slate-100 flex justify-between items-center">
          <h2 class="font-semibold text-slate-600 flex items-center gap-2">
            <span class="material-symbols-outlined text-[20px]">inbox</span> 未使用项目
          </h2>
          <button
            onclick="createNewItem('unused')"
            class="text-slate-400 hover:text-indigo-600 transition-colors"
            title="添加新项目"
          >
            <span class="material-symbols-outlined">add_circle</span>
          </button>
        </div>
        <div
          id="unused-zone"
          class="flex-1 overflow-y-auto p-3 space-y-3"
          ondragover="handleDragOver(event)"
          ondrop="handleDrop(event, 'unused')"
          ondragleave="handleDragLeave(event)"
        >
          <!-- Items rendered via JS -->
        </div>
      </section>

      <!-- Zone 2: Active Items (Center - Main) -->
      <section class="flex-[2] min-w-[350px] flex flex-col bg-white shadow-xl z-10">
        <div class="p-3 border-b border-slate-200 bg-white flex justify-between items-center">
          <h2 class="font-semibold text-indigo-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-[20px] text-indigo-600">play_circle</span> 激活的提示词链
          </h2>
          <div class="text-xs text-slate-400">顺序 & 注入</div>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50/50 p-4 relative">
          <!-- Sequential List Container -->
          <div class="mb-6">
            <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2 pl-1">顺序流程</h3>
            <div
              id="active-sequential-zone"
              class="min-h-[100px] space-y-1 pb-10"
              ondragover="handleDragOver(event)"
              ondrop="handleDrop(event, 'active-sequential')"
              ondragleave="handleDragLeave(event)"
            >
              <!-- Compact Items Rendered Here -->
              <div
                class="text-center py-8 text-slate-300 border-2 border-dashed border-slate-200 rounded-lg pointer-events-none"
              >
                拖拽项目到此处
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="flex items-center gap-4 py-4 opacity-50">
            <div class="h-px bg-slate-300 flex-1"></div>
            <span class="text-xs text-slate-400 font-mono">注入上下文</span>
            <div class="h-px bg-slate-300 flex-1"></div>
          </div>

          <!-- Injected List Container -->
          <div class="mb-4">
            <h3 class="text-xs font-bold uppercase tracking-wider text-purple-400 mb-2 pl-1 flex justify-between">
              <span>自动注入</span>
              <span class="text-[10px] font-normal normal-case opacity-70">按深度和顺序排序</span>
            </h3>
            <div
              id="active-injected-zone"
              class="min-h-[80px] space-y-3 bg-purple-50/30 rounded-lg p-2 border border-purple-100"
              ondragover="handleDragOver(event)"
              ondrop="handleDrop(event, 'active-injected')"
              ondragleave="handleDragLeave(event)"
            >
              <!-- Injected items rendered here (Fixed sort) -->
            </div>
          </div>
        </div>
      </section>

      <!-- Zone 3: Favorites (Right) -->
      <section class="flex-1 min-w-[300px] flex flex-col border-l border-slate-200 bg-slate-50">
        <div class="p-3 border-b border-slate-200 bg-amber-50 flex justify-between items-center">
          <h2 class="font-semibold text-amber-700 flex items-center gap-2">
            <span class="material-symbols-outlined text-[20px]">star</span> 收藏 / 模板
          </h2>
          <div class="flex items-center gap-2">
            <button
              onclick="createNewFolder()"
              class="text-amber-500 hover:text-amber-700 transition-colors"
              title="新建文件夹"
            >
              <span class="material-symbols-outlined text-[20px]">create_new_folder</span>
            </button>
            <div class="text-[10px] text-amber-600/70 bg-amber-100 px-2 py-0.5 rounded-full">拖拽复制</div>
          </div>
        </div>
        <div
          id="favorites-zone"
          class="flex-1 overflow-y-auto p-3 space-y-3"
          ondragover="handleDragOver(event)"
          ondrop="handleDrop(event, 'favorites')"
          ondragleave="handleDragLeave(event)"
        >
          <!-- Favorites Rendered Here -->
        </div>
      </section>
    </main>

    <!-- Floating Mobile Notification -->
    <div
      id="toast"
      class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded shadow-lg text-sm opacity-0 pointer-events-none transition-opacity z-50"
    >
      操作已完成
    </div>

    <!-- JavaScript Logic -->
    <script>
/**
 * PromptFlow Store - 数据存储与条目管理 API
 *
 * 提供统一的接口来读写面板数据和条目列表
 */

// ============================================================================
// 工具函数
// ============================================================================

/** 生成唯一ID（在 ST 环境中使用 uuidv4） */
const generateId = () => {
  try {
    // 尝试使用 ST 的 uuidv4
    if (window.top && window.top.window && window.top.window.SillyTavern) {
      const st = window.top.window.SillyTavern.getContext();
      if (st && st.uuidv4) {
        return st.uuidv4();
      }
    }
  } catch (e) {
    // 忽略跨域错误
  }
  // 回退到简单的 ID 生成
  return Math.random().toString(36).substr(2, 9);
};

/** 深拷贝对象 */
const deepClone = obj => JSON.parse(JSON.stringify(obj));

// ============================================================================
// 默认数据
// ============================================================================

const DEFAULT_DATA = {
  unused: [],
  active: [],
  // 收藏夹支持文件夹结构
  favorites: {
    folders: [], // { id, name, items: [], collapsed: false }
    items: [], // 未分类的项目
  },
};

const STORAGE_KEY = 'promptFlowData';

// ============================================================================
// Store 类 - 核心数据管理
// ============================================================================

class PromptFlowStore {
  constructor() {
    this._state = null;
    this._listeners = new Set();
    this._load();
  }

  // --------------------------------------------------------------------------
  // 私有方法
  // --------------------------------------------------------------------------

  /** 从 localStorage 加载数据 */
  _load() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      this._state = saved ? JSON.parse(saved) : deepClone(DEFAULT_DATA);
      // 确保 favorites 结构正确
      this._ensureFavoritesStructure();
    } catch (e) {
      console.error('Failed to load store data:', e);
      this._state = deepClone(DEFAULT_DATA);
    }
  }

  /** 保存数据到 localStorage */
  _save() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(this._state));
    } catch (e) {
      console.error('Failed to save store data:', e);
    }
  }

  /** 通知所有监听器状态变化 */
  _notify(changeType, payload) {
    this._listeners.forEach(listener => {
      try {
        listener({ type: changeType, payload, state: this._state });
      } catch (e) {
        console.error('Store listener error:', e);
      }
    });
  }

  /** 获取指定区域的列表引用 */
  _getZoneList(zone) {
    const normalizedZone = zone.startsWith('active') ? 'active' : zone;
    if (normalizedZone === 'favorites') {
      // 收藏夹返回未分类的 items
      return this._state.favorites.items;
    }
    return this._state[normalizedZone] || null;
  }

  /** 确保 favorites 数据结构正确（兼容旧数据） */
  _ensureFavoritesStructure() {
    if (Array.isArray(this._state.favorites)) {
      // 旧格式：数组 -> 转换为新格式
      this._state.favorites = {
        folders: [],
        items: this._state.favorites,
      };
    } else if (!this._state.favorites) {
      this._state.favorites = { folders: [], items: [] };
    } else {
      if (!this._state.favorites.folders) this._state.favorites.folders = [];
      if (!this._state.favorites.items) this._state.favorites.items = [];
    }
  }

  // --------------------------------------------------------------------------
  // 公共 API - 状态读取
  // --------------------------------------------------------------------------

  /** 获取完整状态的只读副本 */
  getState() {
    return deepClone(this._state);
  }

  /** 获取指定区域的所有条目 */
  getZone(zone) {
    if (zone === 'favorites') {
      // 返回完整的 favorites 结构
      return deepClone(this._state.favorites);
    }
    const list = this._getZoneList(zone);
    return list ? deepClone(list) : [];
  }

  /** 获取 active 区域中的 sequential 类型条目 */
  getSequentialItems() {
    return this._state.active.filter(i => i.type === 'sequential').map(deepClone);
  }

  /** 获取 active 区域中的 injected 类型条目（已排序） */
  getInjectedItems() {
    return this._state.active
      .filter(i => i.type === 'injected')
      .sort((a, b) => b.depth - a.depth || a.order - b.order)
      .map(deepClone);
  }

  /** 根据 ID 查找条目 */
  getItemById(id) {
    // 检查 unused 和 active
    for (const zone of ['unused', 'active']) {
      const item = this._state[zone].find(i => i.id === id);
      if (item) return { zone, folderId: null, item: deepClone(item) };
    }
    // 检查 favorites.items
    const favItem = this._state.favorites.items.find(i => i.id === id);
    if (favItem) return { zone: 'favorites', folderId: null, item: deepClone(favItem) };
    // 检查 favorites.folders
    for (const folder of this._state.favorites.folders) {
      const item = folder.items.find(i => i.id === id);
      if (item) return { zone: 'favorites', folderId: folder.id, item: deepClone(item) };
    }
    return null;
  }

  /** 查找条目所在的区域 */
  findItemZone(id) {
    for (const zone of ['unused', 'active']) {
      if (this._state[zone].some(i => i.id === id)) {
        return zone;
      }
    }
    // 检查 favorites
    if (this._state.favorites.items.some(i => i.id === id)) {
      return 'favorites';
    }
    for (const folder of this._state.favorites.folders) {
      if (folder.items.some(i => i.id === id)) {
        return 'favorites';
      }
    }
    return null;
  }

  // --------------------------------------------------------------------------
  // 公共 API - 条目 CRUD
  // --------------------------------------------------------------------------

  /**
   * 创建新条目
   * @param {string} zone - 目标区域 ('unused' | 'active' | 'favorites')
   * @param {Partial<Item>} data - 条目数据（可选）
   * @returns {Item} 创建的条目
   */
  createItem(zone, data = {}) {
    const newItem = {
      id: data.identifier || generateId(), // 优先使用 identifier 作为 id
      identifier: data.identifier || generateId(), // ST 兼容字段
      title: 'New Item',
      content: '',
      role: 'system',
      type: 'sequential',
      readOnly: false,
      enabled: true,
      depth: 0,
      order: 0,
      // ST 特殊标记
      marker: false, // 占位符标记，内容不可编辑
      system_prompt: false, // 系统提示词，不可从主面板拖走
      forbid_overrides: false, // 禁止覆盖
      ...data,
    };

    const list = this._getZoneList(zone);
    if (list) {
      list.push(newItem);
      this._save();
      this._notify('item:created', { zone, item: newItem });
    }

    return deepClone(newItem);
  }

  /**
   * 更新条目字段
   * @param {string} id - 条目 ID
   * @param {string} field - 字段名
   * @param {any} value - 新值
   * @returns {boolean} 是否成功
   */
  updateItem(id, field, value) {
    const result = this.getItemById(id);
    if (!result) return false;

    const { zone } = result;
    const list = this._getZoneList(zone);
    const item = list.find(i => i.id === id);

    if (!item) return false;

    // 如果是只读条目，不允许修改内容
    if (field === 'content' && item.readOnly) return false;

    item[field] = value;
    this._save();
    this._notify('item:updated', { zone, id, field, value });

    return true;
  }

  /**
   * 批量更新条目
   * @param {string} id - 条目 ID
   * @param {Object} updates - 要更新的字段
   * @returns {boolean} 是否成功
   */
  updateItemBatch(id, updates) {
    const result = this.getItemById(id);
    if (!result) return false;

    const { zone } = result;
    const list = this._getZoneList(zone);
    const item = list.find(i => i.id === id);

    if (!item) return false;

    for (const [field, value] of Object.entries(updates)) {
      if (field === 'content' && item.readOnly) continue;
      item[field] = value;
    }

    this._save();
    this._notify('item:updated', { zone, id, updates });

    return true;
  }

  /**
   * 删除条目
   * @param {string} id - 条目 ID
   * @returns {boolean} 是否成功
   */
  deleteItem(id) {
    // 检查 unused 和 active
    for (const zone of ['unused', 'active']) {
      const index = this._state[zone].findIndex(i => i.id === id);
      if (index !== -1) {
        const [removed] = this._state[zone].splice(index, 1);
        this._save();
        this._notify('item:deleted', { zone, id, item: removed });
        return true;
      }
    }
    // 检查 favorites.items
    const favIndex = this._state.favorites.items.findIndex(i => i.id === id);
    if (favIndex !== -1) {
      const [removed] = this._state.favorites.items.splice(favIndex, 1);
      this._save();
      this._notify('item:deleted', { zone: 'favorites', id, item: removed });
      return true;
    }
    // 检查 favorites.folders
    for (const folder of this._state.favorites.folders) {
      const index = folder.items.findIndex(i => i.id === id);
      if (index !== -1) {
        const [removed] = folder.items.splice(index, 1);
        this._save();
        this._notify('item:deleted', { zone: 'favorites', folderId: folder.id, id, item: removed });
        return true;
      }
    }
    return false;
  }

  /**
   * 切换条目只读状态
   * @param {string} id - 条目 ID
   * @returns {boolean} 新的只读状态，如果失败返回 null
   */
  toggleReadOnly(id) {
    const result = this.getItemById(id);
    if (!result) return null;

    const list = this._getZoneList(result.zone);
    const item = list.find(i => i.id === id);

    if (!item) return null;

    item.readOnly = !item.readOnly;
    this._save();
    this._notify('item:updated', { zone: result.zone, id, field: 'readOnly', value: item.readOnly });

    return item.readOnly;
  }

  /**
   * 切换条目启用/禁用状态
   * @param {string} id - 条目 ID
   * @returns {boolean} 新的启用状态，如果失败返回 null
   */
  toggleEnabled(id) {
    const result = this.getItemById(id);
    if (!result) return null;

    const list = this._getZoneList(result.zone);
    const item = list.find(i => i.id === id);

    if (!item) return null;

    // 如果 enabled 字段不存在，默认为 true
    item.enabled = !(item.enabled !== false);
    this._save();
    this._notify('item:updated', { zone: result.zone, id, field: 'enabled', value: item.enabled });

    return item.enabled;
  }

  // --------------------------------------------------------------------------
  // 公共 API - 条目移动
  // --------------------------------------------------------------------------

  /**
   * 移动条目到另一个区域
   * @param {string} id - 条目 ID
   * @param {string} targetZone - 目标区域（可以是 'favorites:folderId' 格式）
   * @param {number} targetIndex - 目标位置索引（-1 表示末尾）
   * @param {Object} options - 选项
   * @param {boolean} options.copy - 是否复制而非移动
   * @param {string} options.newType - 新的类型 ('sequential' | 'injected')
   * @returns {Item|null} 移动/复制后的条目
   */
  moveItem(id, targetZone, targetIndex = -1, options = {}) {
    const { copy = false, newType = null } = options;

    const result = this.getItemById(id);
    if (!result) return null;

    const { zone: sourceZone, folderId: sourceFolderId, item } = result;

    // 解析目标区域（可能包含文件夹 ID）
    let normalizedTargetZone = targetZone.startsWith('active') ? 'active' : targetZone;
    let targetFolderId = null;
    if (normalizedTargetZone.startsWith('favorites:')) {
      targetFolderId = normalizedTargetZone.split(':')[1];
      normalizedTargetZone = 'favorites';
    }

    // 判断是否在同一列表
    const isSameList = sourceZone === normalizedTargetZone && sourceFolderId === targetFolderId;

    // 准备新条目
    let newItem;
    let sourceIndex = -1;

    if (copy) {
      newItem = { ...item, id: generateId(), identifier: generateId() };
    } else {
      // 从源位置移除
      const sourceList = this._getSourceList(sourceZone, sourceFolderId);
      sourceIndex = sourceList.findIndex(i => i.id === id);
      if (sourceIndex !== -1) {
        [newItem] = sourceList.splice(sourceIndex, 1);
      } else {
        return null;
      }
    }

    // 更新类型（如果指定）
    if (newType) {
      newItem.type = newType;
    }

    // 获取目标列表
    const targetList = this._getTargetList(normalizedTargetZone, targetFolderId);

    // 调整目标索引（同一列表向下移动时，因为源已被移除，索引需要减 1）
    let adjustedIndex = targetIndex;
    if (!copy && isSameList && sourceIndex !== -1 && targetIndex > sourceIndex) {
      adjustedIndex = targetIndex - 1;
    }

    if (adjustedIndex === -1 || adjustedIndex >= targetList.length) {
      targetList.push(newItem);
    } else {
      targetList.splice(adjustedIndex, 0, newItem);
    }

    this._save();
    this._notify('item:moved', {
      sourceZone,
      sourceFolderId,
      targetZone: normalizedTargetZone,
      targetFolderId,
      id: item.id,
      newId: newItem.id,
      copy,
    });

    return deepClone(newItem);
  }

  /** 获取源列表（支持文件夹） */
  _getSourceList(zone, folderId) {
    if (zone === 'favorites') {
      if (folderId) {
        const folder = this._state.favorites.folders.find(f => f.id === folderId);
        return folder ? folder.items : [];
      }
      return this._state.favorites.items;
    }
    return this._state[zone] || [];
  }

  /** 获取目标列表（支持文件夹） */
  _getTargetList(zone, folderId) {
    if (zone === 'favorites') {
      if (folderId) {
        const folder = this._state.favorites.folders.find(f => f.id === folderId);
        return folder ? folder.items : this._state.favorites.items;
      }
      return this._state.favorites.items;
    }
    return this._state[zone] || [];
  }

  /**
   * 在同一区域内重新排序条目
   * @param {string} zone - 区域
   * @param {string} id - 条目 ID
   * @param {number} newIndex - 新位置索引
   * @returns {boolean} 是否成功
   */
  reorderItem(zone, id, newIndex) {
    const list = this._getZoneList(zone);
    if (!list) return false;

    const currentIndex = list.findIndex(i => i.id === id);
    if (currentIndex === -1) return false;

    const [item] = list.splice(currentIndex, 1);
    const adjustedIndex = newIndex > currentIndex ? newIndex - 1 : newIndex;
    list.splice(Math.min(adjustedIndex, list.length), 0, item);

    this._save();
    this._notify('item:reordered', { zone, id, oldIndex: currentIndex, newIndex: adjustedIndex });

    return true;
  }

  // --------------------------------------------------------------------------
  // 公共 API - 文件夹操作
  // --------------------------------------------------------------------------

  /**
   * 创建文件夹
   * @param {string} name - 文件夹名称
   * @returns {Object} 创建的文件夹
   */
  createFolder(name = '新文件夹') {
    const folder = {
      id: generateId(),
      name,
      items: [],
      collapsed: false,
    };
    this._state.favorites.folders.push(folder);
    this._save();
    this._notify('folder:created', { folder });
    return deepClone(folder);
  }

  /**
   * 更新文件夹
   * @param {string} folderId - 文件夹 ID
   * @param {Object} updates - 更新的字段
   * @returns {boolean} 是否成功
   */
  updateFolder(folderId, updates) {
    const folder = this._state.favorites.folders.find(f => f.id === folderId);
    if (!folder) return false;

    Object.assign(folder, updates);
    this._save();
    this._notify('folder:updated', { folderId, updates });
    return true;
  }

  /**
   * 删除文件夹
   * @param {string} folderId - 文件夹 ID
   * @param {boolean} deleteItems - 是否删除文件夹内的项目，否则移到未分类
   * @returns {boolean} 是否成功
   */
  deleteFolder(folderId, deleteItems = false) {
    const index = this._state.favorites.folders.findIndex(f => f.id === folderId);
    if (index === -1) return false;

    const [folder] = this._state.favorites.folders.splice(index, 1);

    if (!deleteItems && folder.items.length > 0) {
      // 将文件夹内的项目移到未分类
      this._state.favorites.items.push(...folder.items);
    }

    this._save();
    this._notify('folder:deleted', { folderId, deletedItems: deleteItems });
    return true;
  }

  /**
   * 重新排序文件夹
   * @param {string} folderId - 文件夹 ID
   * @param {number} newIndex - 新位置索引
   * @returns {boolean} 是否成功
   */
  reorderFolder(folderId, newIndex) {
    const folders = this._state.favorites.folders;
    const currentIndex = folders.findIndex(f => f.id === folderId);
    if (currentIndex === -1) return false;

    const [folder] = folders.splice(currentIndex, 1);
    const adjustedIndex = newIndex > currentIndex ? newIndex - 1 : newIndex;
    folders.splice(Math.min(adjustedIndex, folders.length), 0, folder);

    this._save();
    this._notify('folder:reordered', { folderId, oldIndex: currentIndex, newIndex: adjustedIndex });
    return true;
  }

  /**
   * 切换文件夹折叠状态
   * @param {string} folderId - 文件夹 ID
   * @returns {boolean} 新的折叠状态
   */
  toggleFolderCollapsed(folderId) {
    const folder = this._state.favorites.folders.find(f => f.id === folderId);
    if (!folder) return null;

    folder.collapsed = !folder.collapsed;
    this._save();
    this._notify('folder:updated', { folderId, updates: { collapsed: folder.collapsed } });
    return folder.collapsed;
  }

  /**
   * 获取所有文件夹
   * @returns {Array} 文件夹列表
   */
  getFolders() {
    return deepClone(this._state.favorites.folders);
  }

  /**
   * 获取收藏夹完整数据（用于保存到 ST）
   * @returns {Object} 收藏夹数据
   */
  getFavoritesData() {
    return deepClone(this._state.favorites);
  }

  /**
   * 设置收藏夹数据（用于从 ST 加载）
   * @param {Object} data - 收藏夹数据
   */
  setFavoritesData(data) {
    if (Array.isArray(data)) {
      // 兼容旧格式
      this._state.favorites = { folders: [], items: data };
    } else if (data && typeof data === 'object') {
      this._state.favorites = {
        folders: data.folders || [],
        items: data.items || [],
      };
    }
    this._save();
    this._notify('favorites:loaded', {});
  }

  // --------------------------------------------------------------------------
  // 公共 API - 导入/导出
  // --------------------------------------------------------------------------

  /**
   * 导出完整数据为 JSON 字符串
   * @returns {string} JSON 字符串
   */
  exportData() {
    return JSON.stringify(this._state, null, 2);
  }

  /**
   * 导入数据
   * @param {string|Object} data - JSON 字符串或对象
   * @param {boolean} merge - 是否合并而非替换
   * @returns {boolean} 是否成功
   */
  importData(data, merge = false) {
    try {
      const parsed = typeof data === 'string' ? JSON.parse(data) : data;

      if (merge) {
        // 合并模式：添加不存在的条目
        for (const zone of ['unused', 'active']) {
          if (parsed[zone]) {
            for (const item of parsed[zone]) {
              if (!this._state[zone].some(i => i.id === item.id)) {
                this._state[zone].push(item);
              }
            }
          }
        }
        // favorites 特殊处理
        if (parsed.favorites) {
          const favData = Array.isArray(parsed.favorites) ? { folders: [], items: parsed.favorites } : parsed.favorites;
          // 合并 items
          for (const item of favData.items || []) {
            if (!this._state.favorites.items.some(i => i.id === item.id)) {
              this._state.favorites.items.push(item);
            }
          }
          // 合并 folders
          for (const folder of favData.folders || []) {
            const existing = this._state.favorites.folders.find(f => f.id === folder.id);
            if (!existing) {
              this._state.favorites.folders.push(folder);
            }
          }
        }
      } else {
        // 替换模式
        const favData = parsed.favorites
          ? Array.isArray(parsed.favorites)
            ? { folders: [], items: parsed.favorites }
            : parsed.favorites
          : { folders: [], items: [] };

        this._state = {
          unused: parsed.unused || [],
          active: parsed.active || [],
          favorites: favData,
        };
      }

      this._ensureFavoritesStructure();
      this._save();
      this._notify('data:imported', { merge });
      return true;
    } catch (e) {
      console.error('Failed to import data:', e);
      return false;
    }
  }

  /**
   * 重置为默认数据
   */
  reset() {
    this._state = deepClone(DEFAULT_DATA);
    this._save();
    this._notify('data:reset', {});
  }

  /**
   * 清除 localStorage 并重新加载页面
   */
  hardReset() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  // --------------------------------------------------------------------------
  // 公共 API - 事件监听
  // --------------------------------------------------------------------------

  /**
   * 订阅状态变化
   * @param {Function} listener - 监听函数
   * @returns {Function} 取消订阅的函数
   */
  subscribe(listener) {
    this._listeners.add(listener);
    return () => this._listeners.delete(listener);
  }

  // --------------------------------------------------------------------------
  // 公共 API - 便捷方法
  // --------------------------------------------------------------------------

  /**
   * 生成最终的 Prompt 文本
   * @param {Object} options - 选项
   * @param {string} options.separator - 分隔符，默认 '\n\n'
   * @param {boolean} options.includeRole - 是否包含角色前缀
   * @returns {string} 拼接后的 Prompt
   */
  generatePrompt(options = {}) {
    const { separator = '\n\n', includeRole = false, includeDisabled = false } = options;

    const sequential = this.getSequentialItems();
    const injected = this.getInjectedItems();
    const all = [...sequential, ...injected];

    return all
      .filter(item => includeDisabled || item.enabled !== false)
      .map(item => {
        if (includeRole) {
          return `[${item.role.toUpperCase()}]\n${item.content}`;
        }
        return item.content;
      })
      .filter(Boolean)
      .join(separator);
  }

  /**
   * 复制条目到另一个区域
   * @param {string} id - 条目 ID
   * @param {string} targetZone - 目标区域
   * @returns {Item|null} 复制后的新条目
   */
  copyItem(id, targetZone) {
    return this.moveItem(id, targetZone, -1, { copy: true });
  }

  /**
   * 克隆条目（在同一区域内复制）
   * @param {string} id - 条目 ID
   * @returns {Item|null} 克隆后的新条目
   */
  cloneItem(id) {
    const result = this.getItemById(id);
    if (!result) return null;

    const { zone, item } = result;
    const cloned = this.createItem(zone, {
      ...item,
      id: undefined, // 让 createItem 生成新 ID
      title: `${item.title} (Copy)`,
    });

    return cloned;
  }
}

// ============================================================================
// 导出单例
// ============================================================================

const store = new PromptFlowStore();

// 为了兼容现有代码，也导出一些便捷函数
const Store = {
  // 实例
  instance: store,

  // 状态读取
  getState: () => store.getState(),
  getZone: zone => store.getZone(zone),
  getSequentialItems: () => store.getSequentialItems(),
  getInjectedItems: () => store.getInjectedItems(),
  getItemById: id => store.getItemById(id),
  findItemZone: id => store.findItemZone(id),

  // CRUD
  createItem: (zone, data) => store.createItem(zone, data),
  updateItem: (id, field, value) => store.updateItem(id, field, value),
  updateItemBatch: (id, updates) => store.updateItemBatch(id, updates),
  deleteItem: id => store.deleteItem(id),
  toggleReadOnly: id => store.toggleReadOnly(id),
  toggleEnabled: id => store.toggleEnabled(id),

  // 移动
  moveItem: (id, targetZone, targetIndex, options) => store.moveItem(id, targetZone, targetIndex, options),
  reorderItem: (zone, id, newIndex) => store.reorderItem(zone, id, newIndex),
  copyItem: (id, targetZone) => store.copyItem(id, targetZone),
  cloneItem: id => store.cloneItem(id),

  // 文件夹操作
  createFolder: name => store.createFolder(name),
  updateFolder: (folderId, updates) => store.updateFolder(folderId, updates),
  deleteFolder: (folderId, deleteItems) => store.deleteFolder(folderId, deleteItems),
  reorderFolder: (folderId, newIndex) => store.reorderFolder(folderId, newIndex),
  toggleFolderCollapsed: folderId => store.toggleFolderCollapsed(folderId),
  getFolders: () => store.getFolders(),
  getFavoritesData: () => store.getFavoritesData(),
  setFavoritesData: data => store.setFavoritesData(data),

  // 导入导出
  exportData: () => store.exportData(),
  importData: (data, merge) => store.importData(data, merge),
  reset: () => store.reset(),
  hardReset: () => store.hardReset(),

  // 事件
  subscribe: listener => store.subscribe(listener),

  // 便捷方法
  generatePrompt: options => store.generatePrompt(options),
  generateId,
};

// 兼容全局访问
window.Store = Store;
window.PromptFlowStore = PromptFlowStore;

</script>
    <script>
// --- UI State (Drag & Drop) ---
// 注意：数据存储已移至 store.js，这里只保留 UI 相关状态

const dragState = {
  isDragging: false,
  sourceZone: null,
  itemId: null,
  itemData: null,
  ghostElement: null,
  previewElement: null,
  originalElement: null,
  offsetX: 0,
  offsetY: 0,
  currentDropZone: null,
  currentDropIndex: -1,
};

// 便捷引用 Store API
const uuid = Store.generateId;

// --- Core Rendering Functions ---

function init() {
  renderAll();
  setupCardExpansionTracking();
}

// 自动调整 textarea 高度（最大高度 400px）
function autoResizeTextarea(textarea) {
  if (!textarea) return;
  const maxHeight = 400;
  const minHeight = 120;

  // 临时移除最小高度限制，设为 0 以获取真实的 scrollHeight
  textarea.style.minHeight = '0';
  textarea.style.height = '0';

  // 计算新高度
  const scrollHeight = textarea.scrollHeight;
  const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);

  // 设置新高度
  textarea.style.height = newHeight + 'px';
  textarea.style.minHeight = minHeight + 'px';

  // 根据是否达到最大高度来设置滚动
  textarea.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden';
}

// 设置卡片展开追踪（只用于主面板的点击展开功能）
function setupCardExpansionTracking() {
  // 点击外部区域时收起所有展开的卡片
  document.addEventListener('click', e => {
    const clickedCard = e.target.closest('.compact-card');
    const isInsideExpandedPanel = e.target.closest('.hide-when-compact');

    // 如果点击的不是卡片，也不是展开面板内部，收起所有卡片
    if (!clickedCard && !isInsideExpandedPanel) {
      document.querySelectorAll('.compact-card.click-expanded').forEach(card => {
        card.classList.remove('click-expanded');
      });
    }
  });
}

// 切换卡片展开/收起状态（点击触发）
function toggleCardExpand(itemId) {
  const card = document.getElementById(itemId);
  if (!card || !card.classList.contains('compact-card')) return;

  // 如果正在拖拽，不处理点击
  if (document.body.classList.contains('is-dragging')) return;

  const isExpanded = card.classList.contains('click-expanded');

  // 先收起其他展开的卡片
  document.querySelectorAll('.compact-card.click-expanded').forEach(other => {
    if (other !== card) {
      other.classList.remove('click-expanded');
    }
  });

  // 切换当前卡片状态
  if (isExpanded) {
    card.classList.remove('click-expanded');
  } else {
    card.classList.add('click-expanded');
    // 展开后初始化 textarea 高度
    requestAnimationFrame(() => {
      const textarea = card.querySelector('textarea[data-field="content"]');
      if (textarea) {
        autoResizeTextarea(textarea);
      }
    });
  }
}

// 切换条目启用/禁用状态
function toggleItemEnabled(itemId) {
  Store.toggleEnabled(itemId);
  renderAll();
}

// 保存卡片内的修改
function saveCardChanges(itemId) {
  const card = document.getElementById(itemId);
  if (!card) return;

  const updates = {};

  // 收集所有带 data-field 的输入元素
  card.querySelectorAll('.compact-card-input[data-field]').forEach(input => {
    const field = input.dataset.field;
    const value = input.type === 'checkbox' ? input.checked : input.value;
    updates[field] = value;
  });

  // 批量更新
  Store.updateItemBatch(itemId, updates);

  // 如果类型变化，需要重新渲染
  if (updates.type) {
    renderAll();
  } else {
    // 否则只更新当前卡片显示
    renderAll();
  }

  showToast('更改已保存');
}

function resetData() {
  if (confirm('确定要重置所有数据到默认值吗？')) {
    Store.hardReset();
  }
}

function renderAll() {
  renderZone('unused', Store.getZone('unused'));
  renderZone('favorites', Store.getZone('favorites'));
  renderActiveZone();
}

// --- Render Helpers ---

// 转义 HTML 特殊字符，防止内容预览被解析为 HTML
function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function getRoleColor(role) {
  switch (role) {
    case 'system':
      return 'bg-blue-50 border-blue-200 text-blue-900';
    case 'user':
      return 'bg-green-50 border-green-200 text-green-900';
    case 'model':
      return 'bg-purple-50 border-purple-200 text-purple-900';
    default:
      return 'bg-white border-slate-200';
  }
}

function getRoleBadge(role) {
  const colors = {
    system: 'bg-blue-100 text-blue-700',
    user: 'bg-green-100 text-green-700',
    model: 'bg-purple-100 text-purple-700',
  };
  return `<span class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${
    colors[role] || 'bg-slate-200'
  }">${role}</span>`;
}

// Render generic item card (Used for Unused & Favorites)
function createItemHTML(item, zone, isCompact = false) {
  const roleClass = getRoleColor(item.role);
  const draggable = true;

  // For active zone, we might need different HTML structure
  if (isCompact) return createCompactItemHTML(item);

  return `
                <div id="${item.id}" 
                     draggable="${draggable}" 
                     ondragstart="handleDragStart(event, '${zone}', '${item.id}')"
                     class="relative group rounded-md border p-3 shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing bg-white border-slate-200"
                >
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-slate-300 cursor-move text-sm">drag_indicator</span>
                            <input type="text" value="${escapeHtml(item.title)}" 
                                   onchange="updateItem('${zone}', '${item.id}', 'title', this.value)"
                                   class="font-medium text-sm text-slate-700 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none w-32" 
                                   placeholder="标题">
                        </div>
                        ${getRoleBadge(item.role)}
                    </div>
                    
                    <textarea 
                        onchange="updateItem('${zone}', '${item.id}', 'content', this.value)"
                        ${item.readOnly ? 'disabled' : ''}
                        class="w-full text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded p-2 focus:ring-1 focus:ring-indigo-500 focus:outline-none resize-none h-20 ${
                          item.readOnly ? 'opacity-70 cursor-not-allowed' : ''
                        }"
                        placeholder="输入提示词内容...">${item.content}</textarea>

                    <div class="flex justify-between items-center mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="flex gap-2">
                            <select onchange="updateItem('${zone}', '${
    item.id
  }', 'role', this.value)" class="text-[10px] bg-slate-100 border border-slate-200 rounded px-1">
                                <option value="system" ${item.role === 'system' ? 'selected' : ''}>系统</option>
                                <option value="user" ${item.role === 'user' ? 'selected' : ''}>用户</option>
                                <option value="model" ${item.role === 'model' ? 'selected' : ''}>模型</option>
                            </select>
                            <select onchange="updateItemTypeAndReflow('${zone}', '${
    item.id
  }', this.value)" class="text-[10px] bg-slate-100 border border-slate-200 rounded px-1">
                                <option value="sequential" ${item.type === 'sequential' ? 'selected' : ''}>顺序</option>
                                <option value="injected" ${item.type === 'injected' ? 'selected' : ''}>注入</option>
                            </select>
                        </div>
                        <div class="flex gap-1">
                            ${
                              zone !== 'active-injected'
                                ? `
                            <button onclick="toggleReadOnly('${zone}', '${
                                    item.id
                                  }')" class="text-slate-400 hover:text-slate-600" title="切换只读">
                                <span class="material-symbols-outlined text-[16px]">${
                                  item.readOnly ? 'lock' : 'lock_open'
                                }</span>
                            </button>`
                                : ''
                            }
                            <button onclick="deleteItem('${zone}', '${
    item.id
  }')" class="text-slate-400 hover:text-red-500" title="删除">
                                <span class="material-symbols-outlined text-[16px]">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    ${
                      item.type === 'injected'
                        ? `
                        <div class="mt-2 pt-2 border-t border-slate-100 grid grid-cols-2 gap-2">
                            <label class="text-[10px] text-slate-500 flex flex-col">
                                深度
                                <input type="number" value="${item.depth || 0}" onchange="updateItem('${zone}', '${
                            item.id
                          }', 'depth', parseInt(this.value))" class="border border-slate-200 rounded px-1 text-xs">
                            </label>
                            <label class="text-[10px] text-slate-500 flex flex-col">
                                顺序
                                <input type="number" value="${item.order || 0}" onchange="updateItem('${zone}', '${
                            item.id
                          }', 'order', parseInt(this.value))" class="border border-slate-200 rounded px-1 text-xs">
                            </label>
                        </div>
                    `
                        : ''
                    }
                </div>
            `;
}

// Render Compact Item (Main Panel Sequential)
function createCompactItemHTML(item) {
  const isEnabled = item.enabled !== false;
  const isMarker = item.marker === true; // 占位符标记
  const isSystemPrompt = item.system_prompt === true; // 系统提示词
  // chatHistory 和 dialogueExamples 必须保持顺序类型
  const fixedSequentialIdentifiers = ['chatHistory', 'dialogueExamples'];
  const isFixedSequential = fixedSequentialIdentifiers.includes(item.identifier);
  // 所有条目都可以在主面板内拖拽排序，限制在 handleDrop 中处理
  const canDrag = true;
  const roleBorderClass =
    item.role === 'system' ? 'border-l-blue-400' : item.role === 'user' ? 'border-l-green-400' : 'border-l-purple-400';
  const disabledClass = isEnabled ? '' : 'item-disabled';
  const markerClass = isMarker ? 'is-marker' : '';
  const lockedClass = isSystemPrompt ? 'is-locked' : '';

  // 占位符显示特殊内容（转义防止 HTML 注入）
  const displayContent = isMarker
    ? `<span class="italic text-amber-600">[${escapeHtml(item.title)}]</span>`
    : item.content
    ? escapeHtml(item.content)
    : '<span class="italic text-slate-300">Empty...</span>';

  return `
                <div id="${item.id}" 
                     class="compact-card group ${disabledClass} ${markerClass} ${lockedClass}"
                     data-item-id="${item.id}"
                     data-marker="${isMarker}"
                     data-system-prompt="${isSystemPrompt}"
                >
                    <!-- Compact View (Always visible, acts as the base card) -->
                    <div class="show-when-compact items-center border border-slate-200 ${roleBorderClass} border-l-4 rounded-md shadow-sm transition-shadow ${
    isEnabled ? '' : 'bg-slate-100'
  } ${isMarker ? 'bg-amber-50/50' : ''}">
                        <div class="flex items-center w-full h-[50px]">
                            <!-- 拖拽区域：手柄 + role -->
                            <div class="drag-handle flex items-center gap-2 px-3 h-full cursor-grab active:cursor-grabbing shrink-0"
                                 draggable="true"
                                 ondragstart="handleDragStart(event, 'active', '${item.id}')">
                                <span class="material-symbols-outlined text-slate-300 text-sm">drag_handle</span>
                                <span class="text-xs font-bold uppercase ${
                                  isEnabled ? 'text-slate-400' : 'text-slate-300'
                                } w-12">${item.role}</span>
                            </div>
                            <!-- 内容区域：点击展开/收起 -->
                            <div class="content-area flex-1 flex items-center gap-2 px-2 h-full cursor-pointer overflow-hidden"
                                 onclick="toggleCardExpand('${item.id}')">
                                <div class="text-sm ${
                                  isEnabled ? 'text-slate-600' : 'text-slate-400'
                                } truncate flex-1 font-mono">${displayContent}</div>
                                ${
                                  isMarker
                                    ? '<span class="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded shrink-0">占位</span>'
                                    : ''
                                }
                            </div>
                            <!-- 开关按钮 -->
                            <button onclick="toggleItemEnabled('${item.id}')" 
                                    class="shrink-0 px-3 h-full flex items-center hover:bg-slate-50 transition-colors"
                                    title="${isEnabled ? '禁用' : '启用'}">
                                <span class="material-symbols-outlined text-[18px] ${
                                  isEnabled ? 'text-green-500' : 'text-slate-300'
                                }">
                                    ${isEnabled ? 'toggle_on' : 'toggle_off'}
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Expanded Panel (Floats below, doesn't affect layout) -->
                    <div class="hide-when-compact p-3 flex flex-col gap-2">
                        <!-- Header -->
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <input type="text" value="${escapeHtml(item.title)}" 
                                       data-field="title"
                                       ${isMarker ? 'disabled' : ''}
                                       class="compact-card-input font-bold text-sm text-slate-700 focus:outline-none border-b border-transparent focus:border-indigo-500 bg-transparent ${
                                         isMarker ? 'cursor-not-allowed' : ''
                                       }" 
                                       placeholder="标题">
                                ${getRoleBadge(item.role)}
                                ${
                                  isMarker
                                    ? '<span class="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">占位符</span>'
                                    : ''
                                }
                            </div>
                             <div class="flex gap-1">
                                ${
                                  !isMarker
                                    ? `<button onclick="toggleReadOnly('active', '${item.id}')" 
                                        class="text-slate-400 hover:text-indigo-600 p-1 rounded hover:bg-slate-100">
                                    <span class="material-symbols-outlined text-[18px]">${
                                      item.readOnly ? 'lock' : 'lock_open'
                                    }</span>
                                </button>`
                                    : ''
                                }
                                ${
                                  !isSystemPrompt
                                    ? `<button onclick="deleteItem('active', '${item.id}')" 
                                        class="text-slate-400 hover:text-red-500 p-1 rounded hover:bg-slate-100">
                                    <span class="material-symbols-outlined text-[18px]">delete</span>
                                </button>`
                                    : ''
                                }
                            </div>
                        </div>

                        <!-- Editor -->
                        ${
                          isMarker
                            ? `<div class="w-full flex-1 min-h-[60px] text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-3 flex items-center justify-center">
                            <span class="material-symbols-outlined mr-2">info</span>
                            此为占位符，内容由系统动态填充
                        </div>`
                            : `<textarea 
                            data-field="content"
                            ${item.readOnly ? 'disabled' : ''}
                            oninput="autoResizeTextarea(this)"
                            style="min-height: 120px; max-height: 400px; overflow-y: hidden;"
                            class="compact-card-input w-full text-sm font-mono text-slate-700 bg-slate-50 border border-slate-200 rounded p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none ${
                              item.readOnly ? 'opacity-70 cursor-not-allowed' : ''
                            }"
                            placeholder="提示词内容...">${item.content}</textarea>`
                        }

                        <!-- Footer Controls -->
                        <div class="flex justify-between items-center border-t border-slate-100 pt-2">
                             <div class="flex gap-2">
                                <select data-field="role" class="compact-card-input text-xs bg-white border border-slate-300 rounded px-2 py-1 shadow-sm" ${
                                  isMarker ? 'disabled' : ''
                                }>
                                    <option value="system" ${item.role === 'system' ? 'selected' : ''}>系统</option>
                                    <option value="user" ${item.role === 'user' ? 'selected' : ''}>用户</option>
                                    <option value="model" ${item.role === 'model' ? 'selected' : ''}>模型</option>
                                </select>
                                ${
                                  // 非固定顺序的 marker 和普通条目都可以选择类型
                                  !isFixedSequential
                                    ? `<select data-field="type" class="compact-card-input text-xs bg-white border border-slate-300 rounded px-2 py-1 shadow-sm">
                                    <option value="sequential" ${
                                      item.type === 'sequential' ? 'selected' : ''
                                    }>顺序</option>
                                    <option value="injected" ${item.type === 'injected' ? 'selected' : ''}>注入</option>
                                </select>`
                                    : '<span class="text-[10px] text-amber-600 px-2">固定顺序</span>'
                                }
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-400">ID: ${(item.identifier || item.id).substr(
                                  0,
                                  8,
                                )}</span>
                                ${
                                  !isMarker
                                    ? `<button onclick="saveCardChanges('${item.id}')" 
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1 rounded transition-colors">
                                    保存
                                </button>`
                                    : ''
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
}

function renderZone(zoneId, data) {
  const container = document.getElementById(zoneId + '-zone');

  if (zoneId === 'favorites') {
    // favorites 有特殊结构（包含文件夹）
    renderFavoritesZone(container, data);
  } else {
    // 普通区域
    container.innerHTML = data.map(item => createItemHTML(item, zoneId)).join('');
  }
}

// 渲染收藏夹区域（支持文件夹）
function renderFavoritesZone(container, favData) {
  const { folders = [], items = [] } = favData;
  let html = '';

  // 渲染文件夹
  folders.forEach(folder => {
    html += createFolderHTML(folder);
  });

  // 渲染未分类的项目
  if (items.length > 0) {
    html += '<div class="favorites-uncategorized space-y-2 mt-2" data-folder-id="">';
    items.forEach(item => {
      html += createItemHTML(item, 'favorites');
    });
    html += '</div>';
  }

  // 如果没有任何内容，显示提示
  if (folders.length === 0 && items.length === 0) {
    html = `<div class="text-center py-8 text-amber-400 border-2 border-dashed border-amber-200 rounded-lg text-sm pointer-events-none">
              拖拽项目到此处收藏
            </div>`;
  }

  container.innerHTML = html;
}

// 创建文件夹 HTML
function createFolderHTML(folder) {
  const isCollapsed = folder.collapsed;
  const itemCount = folder.items.length;

  let itemsHtml = '';
  if (!isCollapsed) {
    folder.items.forEach(item => {
      itemsHtml += createItemHTML(item, 'favorites');
    });
  }

  return `
    <div class="favorites-folder mb-3 rounded-lg border border-amber-200 bg-amber-50/50 overflow-hidden"
         id="folder-${folder.id}"
         data-folder-id="${folder.id}"
         data-is-folder="true"
         draggable="true"
         ondragstart="handleFolderDragStart(event, '${folder.id}')">
      <!-- 文件夹头部 -->
      <div class="folder-header flex items-center gap-2 px-3 py-2 bg-amber-100/50 cursor-grab active:cursor-grabbing select-none"
           onclick="toggleFolder('${folder.id}')">
        <span class="material-symbols-outlined text-amber-400 text-[16px] mr-1">drag_indicator</span>
        <span class="material-symbols-outlined text-amber-600 text-[18px] transition-transform ${
          isCollapsed ? '' : 'rotate-90'
        }">
          chevron_right
        </span>
        <span class="material-symbols-outlined text-amber-500 text-[18px]">folder</span>
        <input type="text" value="${escapeHtml(folder.name)}" 
               onclick="event.stopPropagation()"
               onchange="renameFolder('${folder.id}', this.value)"
               class="flex-1 font-medium text-sm text-amber-800 bg-transparent border-b border-transparent hover:border-amber-300 focus:border-amber-500 focus:outline-none">
        <span class="text-[10px] text-amber-600 bg-amber-200 px-1.5 py-0.5 rounded">${itemCount}</span>
        <button onclick="event.stopPropagation(); deleteFolderPrompt('${folder.id}')" 
                class="text-amber-400 hover:text-red-500 p-0.5 rounded hover:bg-amber-200/50 transition-colors">
          <span class="material-symbols-outlined text-[16px]">delete</span>
        </button>
      </div>
      <!-- 文件夹内容 -->
      <div class="folder-content ${isCollapsed ? 'hidden' : ''} p-2 space-y-2 min-h-[40px]"
           data-folder-id="${folder.id}">
        ${
          itemsHtml ||
          '<div class="text-center py-3 text-amber-400 text-xs border border-dashed border-amber-200 rounded pointer-events-none">拖拽到此文件夹</div>'
        }
      </div>
    </div>
  `;
}

// 切换文件夹折叠
function toggleFolder(folderId) {
  Store.toggleFolderCollapsed(folderId);
  renderAll();
}

// 重命名文件夹
function renameFolder(folderId, newName) {
  Store.updateFolder(folderId, { name: newName });
}

// 文件夹拖动开始
function handleFolderDragStart(e, folderId) {
  e.stopPropagation();

  const folderElement = document.getElementById(`folder-${folderId}`);
  if (!folderElement) return;

  const folder = Store.getFolders().find(f => f.id === folderId);
  if (!folder) return;

  // 计算鼠标偏移
  const rect = folderElement.getBoundingClientRect();
  const offsetX = e.clientX - rect.left;
  const offsetY = e.clientY - rect.top;

  // 存储拖动状态
  dragState.isDragging = true;
  dragState.sourceZone = 'favorites-folder'; // 特殊标记表示是文件夹
  dragState.itemId = folderId;
  dragState.itemData = { ...folder, isFolder: true };
  dragState.originalElement = folderElement;
  dragState.offsetX = offsetX;
  dragState.offsetY = offsetY;

  // 设置拖动效果
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', JSON.stringify({ id: folderId, isFolder: true }));

  // 隐藏默认拖动图像
  const emptyImg = new Image();
  emptyImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
  e.dataTransfer.setDragImage(emptyImg, 0, 0);

  // 创建幽灵元素
  createFolderGhost(folder, e.clientX, e.clientY, offsetX, offsetY);

  // 隐藏原始元素
  requestAnimationFrame(() => {
    if (dragState.originalElement) {
      dragState.originalElement.style.opacity = '0.3';
    }
  });

  document.body.classList.add('is-dragging');
  document.addEventListener('dragover', handleGlobalDragOver);
  document.addEventListener('dragend', handleDragEnd);
}

// 创建文件夹幽灵元素
function createFolderGhost(folder, x, y, offsetX, offsetY) {
  const ghost = document.createElement('div');
  ghost.id = 'drag-ghost';
  ghost.className = 'drag-ghost';

  ghost.innerHTML = `
    <div class="flex items-center gap-2 w-full">
      <span class="material-symbols-outlined text-amber-400 text-sm">drag_indicator</span>
      <span class="material-symbols-outlined text-amber-500 text-[18px]">folder</span>
      <span class="text-sm text-amber-800 font-medium truncate flex-1">${escapeHtml(folder.name)}</span>
      <span class="text-[10px] text-amber-600 bg-amber-200 px-1.5 py-0.5 rounded">${folder.items.length}</span>
    </div>
  `;

  ghost.style.cssText = `
    position: fixed;
    top: ${y - offsetY}px;
    left: ${x - offsetX}px;
    width: 280px;
    height: 40px;
    padding: 0 12px;
    display: flex;
    align-items: center;
    background: #fffbeb;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    pointer-events: none;
    z-index: 10000;
    opacity: 0.95;
    transform: rotate(1deg) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 8px 16px rgba(0,0,0,0.1);
    font-family: 'Roboto', sans-serif;
  `;

  document.body.appendChild(ghost);
  dragState.ghostElement = ghost;
}

// 删除文件夹确认
function deleteFolderPrompt(folderId) {
  const folder = Store.getFolders().find(f => f.id === folderId);
  if (!folder) return;

  if (folder.items.length > 0) {
    const action = confirm(
      `文件夹 "${folder.name}" 中有 ${folder.items.length} 个项目。\n\n点击"确定"将项目移到未分类，点击"取消"保留文件夹。`,
    );
    if (action) {
      Store.deleteFolder(folderId, false);
      renderAll();
      showToast('文件夹已删除，项目已移到未分类');
    }
  } else {
    Store.deleteFolder(folderId, true);
    renderAll();
    showToast('文件夹已删除');
  }
}

// 创建新文件夹
function createNewFolder() {
  Store.createFolder('新文件夹');
  renderAll();
  showToast('已创建新文件夹');
}

function renderActiveZone() {
  // 使用 Store API 获取已排序的数据
  const sequential = Store.getSequentialItems();
  const injected = Store.getInjectedItems();

  const seqContainer = document.getElementById('active-sequential-zone');
  const injContainer = document.getElementById('active-injected-zone');

  // Render Sequential
  if (sequential.length === 0) {
    seqContainer.innerHTML = `<div class="text-center py-8 text-slate-400 border-2 border-dashed border-slate-200 rounded-lg pointer-events-none text-sm">拖拽顺序项目到此处</div>`;
  } else {
    seqContainer.innerHTML = sequential.map(item => createCompactItemHTML(item)).join('');
  }

  // Render Injected
  if (injected.length === 0) {
    injContainer.innerHTML = `<div class="text-center py-4 text-purple-300 text-xs italic">无注入项目</div>`;
  } else {
    injContainer.innerHTML = injected.map(item => createItemHTML(item, 'active-injected')).join('');
  }
}

// --- CRUD Operations (使用 Store API) ---

function createNewItem(targetZone) {
  Store.createItem(targetZone);
  renderAll();
}

function deleteItem(zone, id) {
  if (!confirm('确定要删除此项目吗？')) return;
  Store.deleteItem(id);
  renderAll();
}

function updateItem(zone, id, field, value) {
  const success = Store.updateItem(id, field, value);

  if (success) {
    // 如果 injected 排序参数变化，或 role 变化，需要重新渲染
    if ((field === 'depth' || field === 'order') && zone.startsWith('active')) {
      renderActiveZone();
    } else if (field === 'role') {
      // role 变化需要重新渲染以更新颜色
      renderAll();
    }
  }
}

function updateItemTypeAndReflow(zone, id, newType) {
  Store.updateItem(id, 'type', newType);
  renderAll();
}

function toggleReadOnly(zone, id) {
  Store.toggleReadOnly(id);
  renderAll();
}

// --- Drag and Drop Logic (Enhanced Smooth Experience) ---

function handleDragStart(e, zone, id) {
  // 阻止事件冒泡，防止拖动文件夹内条目时触发文件夹的拖动
  e.stopPropagation();

  const dragHandle = e.target.closest('[draggable="true"]');
  if (!dragHandle) return;

  // 找到整个卡片元素（用于隐藏）
  const cardElement = document.getElementById(id);
  if (!cardElement) return;

  // 使用 Store API 查找条目数据
  const result = Store.getItemById(id);
  if (!result) return;
  const itemData = result.item;

  // Calculate mouse offset relative to drag handle
  const rect = dragHandle.getBoundingClientRect();
  const offsetX = e.clientX - rect.left;
  const offsetY = e.clientY - rect.top;

  // Store drag state
  dragState.isDragging = true;
  dragState.sourceZone = zone;
  dragState.itemId = id;
  dragState.itemData = { ...itemData }; // Clone item data
  dragState.originalElement = cardElement; // 存储整个卡片元素
  dragState.offsetX = offsetX;
  dragState.offsetY = offsetY;

  // Set data transfer
  const isCopyOperation = zone === 'favorites';
  e.dataTransfer.effectAllowed = isCopyOperation ? 'copy' : 'move';
  e.dataTransfer.setData('text/plain', JSON.stringify({ id, zone }));

  // Hide browser's default drag image
  const emptyImg = new Image();
  emptyImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
  e.dataTransfer.setDragImage(emptyImg, 0, 0);

  // Create compact ghost element (follows mouse)
  createCompactGhost(itemData, e.clientX, e.clientY, offsetX, offsetY);

  // For move operations, hide the original element completely
  if (!isCopyOperation) {
    requestAnimationFrame(() => {
      if (dragState.originalElement) {
        dragState.originalElement.style.display = 'none';
      }
    });
  } else {
    // For copy operations, just dim the original slightly
    cardElement.style.opacity = '0.5';
  }

  // Add dragging class to body to disable hover effects
  document.body.classList.add('is-dragging');

  // Add global event listeners
  document.addEventListener('dragover', handleGlobalDragOver);
  document.addEventListener('dragend', handleDragEnd);
}

function createCompactGhost(item, x, y, offsetX, offsetY) {
  // Create a compact-style ghost element
  const roleBorderColor = item.role === 'system' ? '#60a5fa' : item.role === 'user' ? '#4ade80' : '#c084fc';

  const ghost = document.createElement('div');
  ghost.id = 'drag-ghost';
  ghost.className = 'drag-ghost';

  ghost.innerHTML = `
    <div class="flex items-center gap-3 w-full">
      <span class="material-symbols-outlined text-slate-300 text-sm">drag_handle</span>
      <span class="text-xs font-bold uppercase text-slate-400 w-12 shrink-0">${item.role}</span>
      <div class="text-sm text-slate-600 truncate flex-1 font-mono">${
        item.content
          ? escapeHtml(item.content.substring(0, 50)) + (item.content.length > 50 ? '...' : '')
          : '<span class="italic text-slate-300">Empty...</span>'
      }</div>
    </div>
  `;

  ghost.style.cssText = `
    position: fixed;
    top: ${y - offsetY}px;
    left: ${x - offsetX}px;
    width: 320px;
    height: 50px;
    padding: 0 12px;
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #e2e8f0;
    border-left: 4px solid ${roleBorderColor};
    border-radius: 6px;
    pointer-events: none;
    z-index: 10000;
    opacity: 0.95;
    transform: rotate(1deg) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 8px 16px rgba(0,0,0,0.1);
    font-family: 'Roboto', sans-serif;
    overflow: hidden;
  `;

  document.body.appendChild(ghost);
  dragState.ghostElement = ghost;
}

function handleGlobalDragOver(e) {
  e.preventDefault();

  // Update ghost position with correct offset
  if (dragState.ghostElement) {
    dragState.ghostElement.style.left = `${e.clientX - dragState.offsetX}px`;
    dragState.ghostElement.style.top = `${e.clientY - dragState.offsetY}px`;
  }
}

function handleDragOver(e) {
  e.preventDefault();
  if (!dragState.isDragging) return;

  const zone = e.currentTarget;
  zone.classList.add('drop-zone-active');
  e.dataTransfer.dropEffect = dragState.sourceZone === 'favorites' ? 'copy' : 'move';

  // 对于收藏夹，需要检测是否在文件夹内
  if (zone.id === 'favorites-zone') {
    updateFavoritesDropPreview(e, zone);
  } else {
    // Update preview element position
    updateDropPreview(zone, e.clientY);
  }
}

// 收藏夹拖拽预览处理
function updateFavoritesDropPreview(e, zone) {
  if (!dragState.itemData) return;

  // 如果是文件夹拖动，使用文件夹级别的预览
  if (dragState.sourceZone === 'favorites-folder') {
    updateFolderDropPreview(e, zone);
    return;
  }

  // 检测鼠标下方的元素，找到目标文件夹
  const path = e.composedPath ? e.composedPath() : e.path || [];
  let targetContainer = null;
  let targetFolderId = null;

  for (const el of path) {
    if (el === zone) break; // 到达容器本身，停止
    if (el.classList && el.classList.contains('folder-content')) {
      // 在文件夹内容区域内
      targetContainer = el;
      targetFolderId = el.dataset.folderId;
      break;
    }
    if (el.classList && el.classList.contains('favorites-uncategorized')) {
      // 在未分类区域内
      targetContainer = el;
      targetFolderId = null;
      break;
    }
  }

  // 如果没有找到特定容器，使用整个收藏夹区域
  if (!targetContainer) {
    // 查找未分类区域或使用 zone 本身
    targetContainer = zone.querySelector('.favorites-uncategorized') || zone;
  }

  // 高亮目标容器
  zone.querySelectorAll('.folder-content, .favorites-uncategorized').forEach(el => {
    el.classList.remove('drop-zone-active');
  });
  if (targetContainer !== zone) {
    targetContainer.classList.add('drop-zone-active');
  }

  // 更新预览
  updateDropPreview(targetContainer, e.clientY);
}

// 文件夹拖动预览
function updateFolderDropPreview(e, zone) {
  // 移除旧的预览
  if (dragState.previewElement) {
    dragState.previewElement.remove();
    dragState.previewElement = null;
  }

  const folderElements = [...zone.querySelectorAll('.favorites-folder')].filter(
    el => el.id !== `folder-${dragState.itemId}`,
  );

  // 找到插入位置
  let insertBeforeElement = null;
  for (const el of folderElements) {
    const box = el.getBoundingClientRect();
    const middleY = box.top + box.height / 2;
    if (e.clientY < middleY) {
      insertBeforeElement = el;
      break;
    }
  }

  // 创建文件夹预览
  const preview = document.createElement('div');
  preview.className = 'drop-preview';
  preview.innerHTML = `
    <div class="flex items-center gap-2 w-full">
      <span class="material-symbols-outlined text-amber-400 text-sm">drag_indicator</span>
      <span class="material-symbols-outlined text-amber-500 text-[18px]">folder</span>
      <span class="text-sm text-amber-700">${escapeHtml(dragState.itemData.name)}</span>
    </div>
  `;
  preview.style.cssText = `
    height: 40px;
    padding: 0 12px;
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
    border: 2px dashed #fbbf24;
    border-radius: 8px;
    margin: 4px 0;
    opacity: 0.8;
    pointer-events: none;
  `;

  if (insertBeforeElement) {
    zone.insertBefore(preview, insertBeforeElement);
  } else {
    // 插入到未分类区域之前（如果存在）
    const uncategorized = zone.querySelector('.favorites-uncategorized');
    if (uncategorized) {
      zone.insertBefore(preview, uncategorized);
    } else {
      zone.appendChild(preview);
    }
  }

  dragState.previewElement = preview;
  dragState.currentDropZone = zone;
}

function updateDropPreview(container, y) {
  if (!dragState.itemData) return;

  // 获取容器的直接子元素中的可拖拽卡片
  // 对于主面板，是 .compact-card；对于其他面板，是带 draggable 的元素
  const cardElements = [...container.children].filter(el => {
    if (el.classList.contains('drop-preview')) return false;
    if (el.id === dragState.itemId) return false;
    // 检查是否是卡片元素（排除文件夹和提示文字）
    if (el.classList.contains('favorites-folder')) return false;
    if (el.classList.contains('favorites-uncategorized')) return false;
    if (el.classList.contains('pointer-events-none')) return false;
    return el.classList.contains('compact-card') || el.hasAttribute('draggable');
  });

  // Find insertion position
  let insertBeforeElement = null;
  let insertIndex = cardElements.length;

  for (let i = 0; i < cardElements.length; i++) {
    const child = cardElements[i];
    const box = child.getBoundingClientRect();
    const middleY = box.top + box.height / 2;

    if (y < middleY) {
      insertBeforeElement = child;
      insertIndex = i;
      break;
    }
  }

  // Check if preview needs to be updated
  const needsUpdate = dragState.currentDropZone !== container || dragState.currentDropIndex !== insertIndex;

  if (!needsUpdate && dragState.previewElement) return;

  // Remove existing preview
  if (dragState.previewElement) {
    dragState.previewElement.remove();
    dragState.previewElement = null;
  }

  // Create preview element
  const preview = createDropPreviewElement(dragState.itemData);

  // Insert preview at the correct position
  if (insertBeforeElement) {
    container.insertBefore(preview, insertBeforeElement);
  } else {
    container.appendChild(preview);
  }

  dragState.previewElement = preview;
  dragState.currentDropZone = container;
  dragState.currentDropIndex = insertIndex;
}

function createDropPreviewElement(item) {
  const roleBorderColor = item.role === 'system' ? '#60a5fa' : item.role === 'user' ? '#4ade80' : '#c084fc';

  const preview = document.createElement('div');
  preview.className = 'drop-preview';

  preview.innerHTML = `
    <div class="flex items-center gap-3 w-full">
      <span class="material-symbols-outlined text-slate-300 text-sm">drag_handle</span>
      <span class="text-xs font-bold uppercase text-slate-400 w-12 shrink-0">${item.role}</span>
      <div class="text-sm text-slate-500 truncate flex-1 font-mono">${
        item.content ? escapeHtml(item.content.substring(0, 40)) + (item.content.length > 40 ? '...' : '') : 'Empty...'
      }</div>
    </div>
  `;

  preview.style.cssText = `
    height: 50px;
    padding: 0 12px;
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
    border: 2px dashed ${roleBorderColor};
    border-radius: 6px;
    margin: 4px 0;
    opacity: 0.8;
    animation: previewPulse 1s ease-in-out infinite;
    font-family: 'Roboto', sans-serif;
    pointer-events: none;
  `;

  return preview;
}

function handleDragLeave(e) {
  // Only remove class if actually leaving the zone
  const relatedTarget = e.relatedTarget;
  const currentTarget = e.currentTarget;

  if (!currentTarget.contains(relatedTarget)) {
    currentTarget.classList.remove('drop-zone-active');

    // 清除收藏夹文件夹的高亮
    if (currentTarget.id === 'favorites-zone') {
      currentTarget.querySelectorAll('.folder-content, .favorites-uncategorized').forEach(el => {
        el.classList.remove('drop-zone-active');
      });
    }

    // Remove preview when leaving this zone
    if (dragState.previewElement && dragState.currentDropZone === currentTarget) {
      dragState.previewElement.remove();
      dragState.previewElement = null;
      dragState.currentDropZone = null;
      dragState.currentDropIndex = -1;
    }
  }
}

function handleDragEnd(e) {
  // Clean up all drag elements
  cleanupDrag();
}

function cleanupDrag() {
  // Remove ghost
  if (dragState.ghostElement) {
    dragState.ghostElement.remove();
    dragState.ghostElement = null;
  }

  // Remove preview element
  if (dragState.previewElement) {
    dragState.previewElement.remove();
    dragState.previewElement = null;
  }

  // Restore original element if it exists (for canceled drags)
  if (dragState.originalElement) {
    dragState.originalElement.style.display = '';
    dragState.originalElement.style.opacity = '';
  }

  // Remove all drop zone highlights
  document.querySelectorAll('.drop-zone-active').forEach(el => {
    el.classList.remove('drop-zone-active');
  });

  // Remove dragging class from body
  document.body.classList.remove('is-dragging');

  // Remove global listeners
  document.removeEventListener('dragover', handleGlobalDragOver);
  document.removeEventListener('dragend', handleDragEnd);

  // Reset state
  dragState.isDragging = false;
  dragState.sourceZone = null;
  dragState.itemId = null;
  dragState.itemData = null;
  dragState.originalElement = null;
  dragState.currentDropZone = null;
  dragState.currentDropIndex = -1;
}

function handleDrop(e, targetZoneId) {
  e.preventDefault();

  if (!dragState.isDragging) return;

  const targetEl = e.currentTarget;
  targetEl.classList.remove('drop-zone-active');

  // 处理文件夹拖放
  if (dragState.sourceZone === 'favorites-folder') {
    handleFolderDrop(e, targetZoneId);
    return;
  }

  // 验证源条目存在
  const result = Store.getItemById(dragState.itemId);
  if (!result) {
    cleanupDrag();
    return;
  }

  // 检查 system_prompt 条目是否试图离开 active 区域
  const item = result.item;
  if (item.system_prompt === true && dragState.sourceZone === 'active') {
    // system_prompt 只能在 active 区域内移动，不能拖到其他区域
    const isStayingInActive = targetZoneId === 'active-sequential' || targetZoneId === 'active-injected';
    if (!isStayingInActive) {
      showToast('系统提示词无法移出主面板');
      cleanupDrag();
      return;
    }
  }

  // 检查 marker 条目是否试图拖到未使用栏
  if (item.marker === true && dragState.sourceZone === 'active' && targetZoneId === 'unused') {
    showToast('占位符无法移到未使用栏');
    cleanupDrag();
    return;
  }

  // 检查 chatHistory 和 dialogueExamples 不能转为注入类型
  const fixedSequentialIdentifiers = ['chatHistory', 'dialogueExamples'];
  if (fixedSequentialIdentifiers.includes(item.identifier) && targetZoneId === 'active-injected') {
    showToast('此占位符必须保持顺序类型');
    cleanupDrag();
    return;
  }

  // 处理收藏夹特殊逻辑
  if (targetZoneId === 'favorites') {
    handleFavoritesDrop(e, result);
    return;
  }

  // 判断是复制还是移动
  // 从收藏栏拖出是复制操作
  const isCopy = dragState.sourceZone === 'favorites';

  // 确定新类型
  let newType = null;
  if (targetZoneId === 'active-injected') {
    newType = 'injected';
  } else if (targetZoneId === 'active-sequential') {
    newType = 'sequential';
  }

  // 计算目标位置索引
  let targetIndex = -1;

  // 对于 injected 类型，位置不重要（会自动排序）
  const isInjectedTarget = targetZoneId === 'active-injected';

  if (!isInjectedTarget) {
    const afterElement = getDragAfterElement(targetEl, e.clientY);
    if (afterElement) {
      // 找到目标列表中该元素的索引
      const targetZone = Store.getZone(targetZoneId);
      if (Array.isArray(targetZone)) {
        targetIndex = targetZone.findIndex(i => i.id === afterElement.id);
      }
    }
  }

  // 使用 Store API 移动/复制条目
  Store.moveItem(dragState.itemId, targetZoneId, targetIndex, {
    copy: isCopy,
    newType: newType,
  });

  // Clean up drag elements before re-render
  cleanupDrag();

  renderAll();
  showToast('项目已更新');
}

// 处理文件夹拖放
function handleFolderDrop(e, targetZoneId) {
  // 文件夹只能在收藏夹内排序
  if (targetZoneId !== 'favorites') {
    showToast('文件夹只能在收藏夹内排序');
    cleanupDrag();
    return;
  }

  const folderId = dragState.itemId;
  const folders = Store.getFolders();

  // 计算目标位置
  const favoritesZone = document.getElementById('favorites-zone');
  const folderElements = [...favoritesZone.querySelectorAll('.favorites-folder')].filter(
    el => el.id !== `folder-${folderId}`,
  );

  let targetIndex = folders.length;
  for (let i = 0; i < folderElements.length; i++) {
    const box = folderElements[i].getBoundingClientRect();
    const middleY = box.top + box.height / 2;
    if (e.clientY < middleY) {
      // 找到这个元素对应的文件夹索引
      const elFolderId = folderElements[i].dataset.folderId;
      targetIndex = folders.findIndex(f => f.id === elFolderId);
      break;
    }
  }

  Store.reorderFolder(folderId, targetIndex);
  cleanupDrag();
  renderAll();
  showToast('文件夹已排序');
}

// 处理收藏夹拖放
function handleFavoritesDrop(e, itemResult) {
  // 检测目标文件夹（通过遍历事件路径查找 data-folder-id）
  let targetFolderId = null;
  let targetContainer = null;
  const path = e.composedPath ? e.composedPath() : e.path || [];

  for (const el of path) {
    if (el.classList && el.classList.contains('folder-content')) {
      targetContainer = el;
      targetFolderId = el.dataset.folderId || null;
      break;
    }
    if (el.classList && el.classList.contains('favorites-uncategorized')) {
      targetContainer = el;
      targetFolderId = null;
      break;
    }
    if (el.dataset && el.dataset.folderId !== undefined) {
      targetFolderId = el.dataset.folderId || null;
      break;
    }
  }

  const sourceZone = dragState.sourceZone;
  const sourceFolderId = itemResult.folderId;

  // 判断是否在收藏夹内移动
  const isWithinFavorites = sourceZone === 'favorites';
  const isSameFolder = isWithinFavorites && sourceFolderId === targetFolderId;

  // 计算目标位置索引
  let targetIndex = -1;

  // 获取目标列表
  const favData = Store.getZone('favorites');
  let targetList = [];
  if (targetFolderId) {
    const folder = favData.folders.find(f => f.id === targetFolderId);
    targetList = folder ? folder.items : [];
  } else {
    targetList = favData.items || [];
  }

  if (targetContainer) {
    // 获取容器中的可拖动元素（排除当前拖动的元素和预览）
    const cardElements = [...targetContainer.children].filter(el => {
      if (el.classList.contains('drop-preview')) return false;
      if (el.classList.contains('pointer-events-none')) return false;
      if (el.id === dragState.itemId) return false;
      return el.hasAttribute('draggable');
    });

    // 找到插入位置
    for (let i = 0; i < cardElements.length; i++) {
      const box = cardElements[i].getBoundingClientRect();
      const middleY = box.top + box.height / 2;
      if (e.clientY < middleY) {
        // 找到这个元素在 targetList 中的索引
        const elId = cardElements[i].id;
        targetIndex = targetList.findIndex(item => item.id === elId);
        break;
      }
    }
  }

  // 确定目标区域
  const targetZone = targetFolderId ? `favorites:${targetFolderId}` : 'favorites';

  // 从其他区域拖入收藏夹是复制，收藏夹内移动是移动
  const isCopy = !isWithinFavorites;

  Store.moveItem(dragState.itemId, targetZone, targetIndex, { copy: isCopy });

  cleanupDrag();
  renderAll();

  if (isCopy) {
    showToast('已复制到收藏夹');
  } else if (isSameFolder) {
    showToast('已排序');
  } else {
    showToast('已移动');
  }
}

// Helper to find position in list
function getDragAfterElement(container, y) {
  // 获取容器的直接子元素中的可拖拽卡片
  const cardElements = [...container.children].filter(el => {
    if (el.classList.contains('drop-preview')) return false;
    if (el.id === dragState.itemId) return false;
    return el.classList.contains('compact-card') || el.hasAttribute('draggable');
  });

  return cardElements.reduce(
    (closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    },
    { offset: Number.NEGATIVE_INFINITY },
  ).element;
}

// --- Utilities ---

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('opacity-0');
  setTimeout(() => t.classList.add('opacity-0'), 2000);
}

function copyFinalPrompt() {
  // 使用 Store API 生成最终 Prompt
  const text = Store.generatePrompt();
  navigator.clipboard.writeText(text).then(() => showToast('完整提示词已复制到剪贴板！'));
}

// --- iframe 环境处理 ---

function isInIframe() {
  return window.self !== window.top;
}

function setupIframeMode() {
  if (!isInIframe()) return;

  try {
    const iframe = window.frameElement;
    if (!iframe) return;

    // 设置 iframe 全屏
    iframe.style.position = 'fixed';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '100vw';
    iframe.style.height = '100vh';
    iframe.style.zIndex = '999999';
    iframe.style.border = 'none';

    // 显示退出按钮
    const exitBtn = document.getElementById('btn-exit-iframe');
    if (exitBtn) {
      exitBtn.classList.remove('hidden');
      exitBtn.classList.add('flex');
    }
  } catch (e) {
    // 跨域情况下无法访问 frameElement，静默失败
    console.warn('无法设置全屏：可能是跨域限制');
  }
}

function exitIframe() {
  if (!isInIframe()) return;

  try {
    const iframe = window.frameElement;
    if (iframe) {
      iframe.remove();
    }
  } catch (e) {
    // 跨域情况下无法访问 frameElement，静默失败
    console.warn('无法退出：可能是跨域限制');
  }
}

// Initialize
init();
setupIframeMode();

</script>
    <script>
/**
 * SillyTavern 集成模块
 *
 * 负责从 SillyTavern 读取提示词列表，转换为编辑器格式，
 * 以及在保存时将修改写回 SillyTavern。
 */
(() => {
  // ============================================================================
  // 工具函数
  // ============================================================================

  /**
   * 获取 SillyTavern 上下文
   * @returns {Object|null} ST 上下文对象
   */
  function getSTContext() {
    try {
      if (window.top && window.top.window && window.top.window.SillyTavern) {
        return window.top.window.SillyTavern.getContext();
      }
    } catch (e) {
      console.warn('[ST Integration] 无法获取 SillyTavern 上下文:', e);
    }
    return null;
  }

  /**
   * 检查是否在 SillyTavern 环境中运行
   */
  function isInSTEnvironment() {
    return getSTContext() !== null;
  }

  // ============================================================================
  // 数据转换
  // ============================================================================

  /**
   * 将 ST 提示词转换为编辑器格式
   * @param {Object} stPrompt - ST 格式的提示词
   * @param {Object} orderInfo - 来自 prompt_order 的信息 (enabled 状态)
   * @returns {Object} 编辑器格式的条目
   */
  function convertSTPromptToEditorItem(stPrompt, orderInfo = null) {
    // 判断类型：injection_position=1 是 injected 类型
    // injection_position=0 或不存在都是顺序提示词
    // marker 也可以是注入类型（除了 chatHistory 和 dialogueExamples）
    const isInjected = stPrompt.injection_position === 1;

    return {
      // 使用 identifier 作为 id，确保唯一性
      id: stPrompt.identifier,
      identifier: stPrompt.identifier,
      title: stPrompt.name || 'Untitled',
      content: stPrompt.content || '',
      role: stPrompt.role || 'system',
      type: isInjected ? 'injected' : 'sequential',
      // 只读状态：marker=true 的是占位符，内容不可编辑
      readOnly: stPrompt.marker === true,
      // enabled 状态从 orderInfo 读取，如果没有则默认 true
      enabled: orderInfo ? orderInfo.enabled !== false : true,
      // 注入相关
      depth: stPrompt.injection_depth || 0,
      order: stPrompt.injection_order || 100,
      // ST 特殊标记
      marker: stPrompt.marker === true,
      system_prompt: stPrompt.system_prompt === true,
      forbid_overrides: stPrompt.forbid_overrides === true,
      // 注入触发器
      injection_trigger: stPrompt.injection_trigger || [],
      injection_position: stPrompt.injection_position || 0,
    };
  }

  /**
   * 将编辑器条目转换回 ST 提示词格式
   * @param {Object} editorItem - 编辑器格式的条目
   * @returns {Object} ST 格式的提示词
   */
  function convertEditorItemToSTPrompt(editorItem) {
    const stPrompt = {
      identifier: editorItem.identifier || editorItem.id,
      name: editorItem.title,
      content: editorItem.content,
      role: editorItem.role,
      system_prompt: editorItem.system_prompt || false,
      marker: editorItem.marker || false,
    };

    // 如果是注入类型，添加注入相关字段
    if (editorItem.type === 'injected') {
      stPrompt.injection_position = 1; // 1 表示注入类型
      stPrompt.injection_depth = editorItem.depth || 0;
      stPrompt.injection_order = editorItem.order || 100;
      stPrompt.injection_trigger = editorItem.injection_trigger || [];
      stPrompt.forbid_overrides = editorItem.forbid_overrides || false;
      stPrompt.enabled = editorItem.enabled !== false;
    } else {
      // 顺序类型，确保 injection_position 为 0
      stPrompt.injection_position = 0;
    }

    return stPrompt;
  }

  // ============================================================================
  // 数据加载
  // ============================================================================

  /**
   * 从 SillyTavern 加载提示词数据到编辑器
   */
  function loadFromST() {
    const st = getSTContext();
    if (!st || !st.chatCompletionSettings) {
      console.log('[ST Integration] 不在 ST 环境中或无法获取设置，使用本地数据');
      return false;
    }

    const settings = st.chatCompletionSettings;
    const prompts = settings.prompts || [];
    const promptOrder = settings.prompt_order || [];

    // 获取 character_id=100001 的 order 数组（这是 active 的提示词列表）
    const activeOrderEntry = promptOrder.find(po => po.character_id === 100001);
    const activeOrder = activeOrderEntry ? activeOrderEntry.order : [];

    // 创建 identifier -> orderInfo 的映射
    const orderInfoMap = new Map();
    activeOrder.forEach((orderItem, index) => {
      orderInfoMap.set(orderItem.identifier, {
        enabled: orderItem.enabled !== false,
        index: index,
      });
    });

    // 创建 identifier -> prompt 的映射
    const promptMap = new Map();
    prompts.forEach(p => promptMap.set(p.identifier, p));

    // 分类条目
    const activeItems = []; // 在 active order 中的条目
    const unusedItems = []; // 不在 active order 中的条目

    // 先按 order 顺序处理 active 条目
    activeOrder.forEach(orderItem => {
      const prompt = promptMap.get(orderItem.identifier);
      if (prompt) {
        const orderInfo = orderInfoMap.get(orderItem.identifier);
        const editorItem = convertSTPromptToEditorItem(prompt, orderInfo);
        activeItems.push(editorItem);
      }
    });

    // 找出不在 active order 中的条目
    prompts.forEach(prompt => {
      if (!orderInfoMap.has(prompt.identifier)) {
        // 只添加非 system_prompt 的条目到 unused
        // system_prompt 类型的条目如果不在 order 中，可能是系统内置的，不显示在 unused
        // injection_position=1 的注入类型条目也添加到 unused
        if (!prompt.system_prompt || prompt.injection_position === 1) {
          const editorItem = convertSTPromptToEditorItem(prompt, null);
          editorItem.enabled = false; // 不在 active 中的默认禁用
          unusedItems.push(editorItem);
        }
      }
    });

    // 导入到 Store
    const storeData = {
      unused: unusedItems,
      active: activeItems,
      favorites: { folders: [], items: [] },
    };

    // 从 ST 扩展设置加载收藏夹
    try {
      const savedPrompts = st.extensionSettings?.SPreset?.editor?.savedPrompts;
      if (savedPrompts) {
        storeData.favorites = savedPrompts;
        console.log('[ST Integration] 已从 ST 加载收藏夹');
      }
    } catch (e) {
      console.warn('[ST Integration] 加载收藏夹失败:', e);
    }

    // 如果 ST 没有收藏夹数据，尝试从本地加载
    if (!storeData.favorites.folders?.length && !storeData.favorites.items?.length) {
      try {
        const localData = localStorage.getItem('promptFlowData');
        if (localData) {
          const parsed = JSON.parse(localData);
          if (parsed.favorites) {
            storeData.favorites = parsed.favorites;
          }
        }
      } catch (e) {
        // 忽略
      }
    }

    Store.importData(storeData, false);
    console.log('[ST Integration] 已从 SillyTavern 加载提示词:', {
      active: activeItems.length,
      unused: unusedItems.length,
    });

    return true;
  }

  // ============================================================================
  // 数据保存
  // ============================================================================

  /**
   * 保存编辑器数据回 SillyTavern
   */
  function saveToST() {
    const st = getSTContext();
    if (!st || !st.chatCompletionSettings) {
      console.warn('[ST Integration] 无法保存：不在 ST 环境中');
      showToast('无法保存：未检测到 SillyTavern');
      return false;
    }

    const settings = st.chatCompletionSettings;
    const state = Store.getState();

    // 获取当前的 prompts 数组
    const existingPrompts = settings.prompts || [];
    const existingPromptsMap = new Map();
    existingPrompts.forEach(p => existingPromptsMap.set(p.identifier, p));

    // 合并编辑器中的修改
    const allEditorItems = [...state.active, ...state.unused];

    allEditorItems.forEach(editorItem => {
      const identifier = editorItem.identifier || editorItem.id;
      const existingPrompt = existingPromptsMap.get(identifier);

      if (existingPrompt) {
        // 更新现有的提示词
        // 只更新允许修改的字段
        if (!editorItem.marker) {
          existingPrompt.content = editorItem.content;
        }
        existingPrompt.name = editorItem.title;
        existingPrompt.role = editorItem.role;

        // 如果是注入类型，更新注入参数
        if (editorItem.type === 'injected') {
          existingPrompt.injection_position = 1;
          existingPrompt.injection_depth = editorItem.depth || 0;
          existingPrompt.injection_order = editorItem.order || 100;
        } else {
          existingPrompt.injection_position = 0;
        }
      } else {
        // 新增的提示词
        const newPrompt = convertEditorItemToSTPrompt(editorItem);
        existingPrompts.push(newPrompt);
      }
    });

    // 更新 prompt_order[1].order（character_id=100001）
    const promptOrder = settings.prompt_order || [];
    let activeOrderEntry = promptOrder.find(po => po.character_id === 100001);

    if (!activeOrderEntry) {
      activeOrderEntry = { character_id: 100001, order: [] };
      promptOrder.push(activeOrderEntry);
    }

    // 重建 order 数组，保持编辑器中 active 的顺序
    const newOrder = state.active.map(item => ({
      identifier: item.identifier || item.id,
      enabled: item.enabled !== false,
    }));

    activeOrderEntry.order = newOrder;

    // 更新 settings（不直接替换整个对象）
    settings.prompts = existingPrompts;
    settings.prompt_order = promptOrder;

    // 保存收藏夹到 ST 扩展设置
    try {
      // 确保 extensionSettings.SPreset.editor 路径存在
      if (!st.extensionSettings) st.extensionSettings = {};
      if (!st.extensionSettings.SPreset) st.extensionSettings.SPreset = {};
      if (!st.extensionSettings.SPreset.editor) st.extensionSettings.SPreset.editor = {};

      // 保存收藏夹数据
      st.extensionSettings.SPreset.editor.savedPrompts = Store.getFavoritesData();
      console.log('[ST Integration] 已保存收藏夹到 ST');
    } catch (e) {
      console.warn('[ST Integration] 保存收藏夹失败:', e);
    }

    console.log('[ST Integration] 已保存到 SillyTavern:', {
      prompts: existingPrompts.length,
      activeOrder: newOrder.length,
    });

    // 调用 ST 的保存函数（如果存在）
    try {
      window.top.window.SPresetImports.promptManager.render(false);
      if (st.saveSettingsDebounced) {
        st.saveSettingsDebounced();
      }
    } catch (e) {
      console.warn('[ST Integration] 调用 ST 保存函数失败:', e);
    }

    return true;
  }

  // ============================================================================
  // 收藏夹实时保存
  // ============================================================================

  /**
   * 保存收藏夹到 ST（实时保存，不保存其他数据）
   */
  function saveFavoritesToST() {
    const st = getSTContext();
    if (!st) return false;

    try {
      // 确保 extensionSettings.SPreset.editor 路径存在
      if (!st.extensionSettings) st.extensionSettings = {};
      if (!st.extensionSettings.SPreset) st.extensionSettings.SPreset = {};
      if (!st.extensionSettings.SPreset.editor) st.extensionSettings.SPreset.editor = {};

      // 保存收藏夹数据
      st.extensionSettings.SPreset.editor.savedPrompts = Store.getFavoritesData();

      // 调用 ST 的保存函数
      if (st.saveSettingsDebounced) {
        st.saveSettingsDebounced();
      }

      return true;
    } catch (e) {
      console.warn('[ST Integration] 保存收藏夹失败:', e);
      return false;
    }
  }

  // ============================================================================
  // 事件绑定
  // ============================================================================

  /**
   * 初始化 ST 集成
   */
  function initSTIntegration() {
    // 绑定保存按钮
    const saveBtn = document.getElementById('btn-save-preset');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        if (isInSTEnvironment()) {
          const success = saveToST();
          if (success) {
            showToast('已保存到 SillyTavern');
          }
        } else {
          // 非 ST 环境，执行本地保存逻辑（已由 Store 自动处理）
          showToast('设置已保存（本地模式）');
        }
      });
    }

    // 如果在 ST 环境中，加载数据并订阅收藏夹变化
    if (isInSTEnvironment()) {
      // 延迟加载，确保 Store 已初始化
      setTimeout(() => {
        loadFromST();
        renderAll();

        // 订阅 Store 变化，实时保存收藏夹
        Store.subscribe(event => {
          // 检查是否是收藏夹相关的变化
          const favoritesEvents = [
            'folder:created',
            'folder:updated',
            'folder:deleted',
            'folder:reordered',
            'favorites:loaded',
          ];

          const isFavoritesChange =
            favoritesEvents.includes(event.type) ||
            (event.type === 'item:moved' &&
              (event.payload.targetZone === 'favorites' || event.payload.sourceZone === 'favorites')) ||
            (event.type === 'item:deleted' && event.payload.zone === 'favorites') ||
            (event.type === 'item:updated' && event.payload.zone === 'favorites') ||
            (event.type === 'item:reordered' && event.payload.zone === 'favorites');

          if (isFavoritesChange) {
            saveFavoritesToST();
          }
        });
      }, 100);
    }
  }

  // ============================================================================
  // 导出 API
  // ============================================================================

  window.STIntegration = {
    getSTContext,
    isInSTEnvironment,
    loadFromST,
    saveToST,
    saveFavoritesToST,
    convertSTPromptToEditorItem,
    convertEditorItemToSTPrompt,
  };

  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSTIntegration);
  } else {
    initSTIntegration();
  }
})();

</script>
  </body>
</html>
